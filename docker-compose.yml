services:
  frontend:
    build:
      context: .
      args:
        VITE_API_URL: /api
    ports:
      - "8080:80"
    depends_on:
      - api
      - upload
    volumes:
      - uploads:/usr/share/nginx/html/uploads:ro

  api:
    build:
      context: ./backend
    expose:
      - "3001"
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PORT: 3001
      JWT_SECRET: ${JWT_SECRET:-monchantier_jwt_secret_change_in_prod}
      DB_JSON_PATH: /data/db.json
    volumes:
      - ./data:/data:ro
    command: sh -c "npx prisma db push && npm start"

  upload:
    image: node:20-alpine
    working_dir: /app
    expose:
      - "3002"
    volumes:
      - ./upload-server:/app
      - uploads:/uploads
    command: sh -c "npm install && npm start"

volumes:
  uploads:
